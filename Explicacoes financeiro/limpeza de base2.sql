DECLARE
	CURSOR C_ERRO IS
		SELECT COUNT(TIT.COD_TITULO_RECEBER),
			   LBA.COD_SOLICITACAO_ERRO,
			   LBA.DAT_LIMPEZA_BASE,
			   LBA.COD_LIMPEZA_BASE,
			   LBA.COD_INSTITUICAO,
			   LBA.COD_ALUNO,
			   ALU.NUM_MATRICULA,
			   LBA.COD_TPO_SAIDA,
			   LBA.COD_SOLICITACAO,
			   SOL.DAT_SOLICITACAO,
			   LBA.DAT_SAIDA,
			   ALU.COD_STA_ALUNO,
			   SSE.COD_PERIODO_LETIVO,
			   ACO.COD_ASS_CONTRATO,
			   ACO.IND_LIBERADO,
			   TCO.IND_TPO_CONTRATO,
			   TCO.NUM_PARCELA NUM_PARC_CONTRATO,
			   FPA.NUM_PARCELA NUM_PARC_PAGAMENTO,
			   'S' IND_SOLICITACAO
		  FROM DBSIAF.LIMPEZA_BASE LBA
		 INNER JOIN ALUNO ALU
			ON (LBA.COD_ALUNO = ALU.COD_ALUNO)
		 INNER JOIN DBSIAF.TITULO_RECEBER TIT
			ON (TIT.COD_ALUNO = LBA.COD_ALUNO)
		 INNER JOIN DBSIAF.SOLICITACAO SOL
			ON (LBA.COD_SOLICITACAO = SOL.COD_SOLICITACAO AND TIT.COD_INSTITUICAO = SOL.COD_INSTITUICAO)
		 INNER JOIN DBSIAF.SERVICO_SECRETARIA SSE
			ON (SOL.COD_SOLICITACAO = SSE.COD_SOLICITACAO AND TIT.COD_PERIODO_LETIVO = SSE.COD_PERIODO_LETIVO)
		 INNER JOIN DBSIAF.PARAMETROS_SOLICITACAO PSO
			ON (SSE.COD_SOLICITACAO = PSO.COD_SOLICITACAO)
		 INNER JOIN DBSIAF.TIPO_CONTRATO TCO
			ON (SSE.COD_PERIODO_LETIVO = TCO.COD_PERIODO_LETIVO)
		 INNER JOIN DBSIAF.ASS_CONTRATO ACO
			ON (TCO.COD_TPO_CONTRATO = ACO.COD_TPO_CONTRATO AND ACO.COD_ALUNO = LBA.COD_ALUNO AND TIT.COD_ASS_CONTRATO = ACO.COD_ASS_CONTRATO AND ACO.COD_INSTITUICAO = TIT.COD_INSTITUICAO)
		 INNER JOIN DBSIAF.TIPO_CONTRATO_PAGAMENTO TCP
			ON (ACO.COD_CTR_PAGAMENTO = TCP.COD_CTR_PAGAMENTO)
		 INNER JOIN DBSIAF.FORMA_PARCELAMENTO FPA
			ON (FPA.COD_FOR_PARCELAMENTO = TCP.COD_FOR_PARCELAMENTO)
		 INNER JOIN DBSIAF.CURSO CUR
			ON (CUR.COD_CURSO = ALU.COD_CURSO)
		 INNER JOIN DBSIAF.TIPO_SOLICITACAO_ETAPA TSE
			ON (TSE.COD_TPO_SOLICITACAO = SOL.COD_TPO_SOLICITACAO)
		 INNER JOIN DBSIAF.ETAPA_STATUS_SOLICITACAO ESS
			ON (ESS.COD_ETAPA_SOLICITACAO = TSE.COD_ETAPA_SOLICITACAO AND ESS.COD_STA_SOLICITACAO = SOL.COD_STA_SOLICITACAO)
		 INNER JOIN DBSIAF.ACAO_PROTOCOLO APR
			ON (APR.COD_ACAO_PROTOCOLO = ESS.COD_ACAO_PROTOCOLO AND APR.COD_TPO_SERVICO IN (2,
																							3))
		 INNER JOIN DBSIAF.TIPO_TITULO TTL
			ON (TTL.COD_TPO_TITULO = TIT.COD_TPO_TITULO AND TTL.IND_FINANCEIRO = 'S' AND TTL.IND_MENSALIDADE = 'S')
		 WHERE /*--LBA.DAT_LIMPEZA_BASE IS NULL
               LBA.COD_LIMPEZA_BASE = 1145992
               and*/
		 LBA.COD_INSTITUICAO = 8
		 AND
		--AND ALU.NUM_MATRICULA = '201306147'
		 TIT.COD_STA_TITULO NOT IN (4,
									6,
									3)
		 AND TIT.DAT_PROG_ORIGINAL > SOL.DAT_SOLICITACAO
		 GROUP BY TIT.COD_STA_TITULO,
				  LBA.COD_SOLICITACAO_ERRO,
				  LBA.DAT_LIMPEZA_BASE,
				  LBA.COD_LIMPEZA_BASE,
				  LBA.COD_INSTITUICAO,
				  LBA.COD_ALUNO,
				  ALU.NUM_MATRICULA,
				  LBA.COD_TPO_SAIDA,
				  LBA.COD_SOLICITACAO,
				  LBA.DAT_SAIDA,
				  SOL.DAT_SOLICITACAO,
				  ALU.COD_STA_ALUNO,
				  SSE.COD_PERIODO_LETIVO,
				  ACO.COD_ASS_CONTRATO,
				  ACO.IND_LIBERADO,
				  TCO.IND_TPO_CONTRATO,
				  TCO.NUM_PARCELA,
				  FPA.NUM_PARCELA;
BEGIN
	FOR R_ERRO IN C_ERRO LOOP
		UPDATE DBSIAF.LIMPEZA_BASE LIM
		   SET LIM.COD_SOLICITACAO_ERRO = NULL,
			   LIM.DAT_LIMPEZA_BASE     = NULL
		 WHERE LIM.COD_LIMPEZA_BASE = R_ERRO.COD_LIMPEZA_BASE; --963274 / 1145992
		COMMIT;
	END LOOP;
	FOR R_ERRO IN C_ERRO LOOP
		DBSIAF.PC_SITUACAO_FINANCEIRA.SP_LIMPEZA_BASE(R_ERRO.COD_LIMPEZA_BASE);
	END LOOP;

END;
