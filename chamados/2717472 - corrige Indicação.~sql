DECLARE

CURSOR C_PRO IS  
  SELECT MAX(NUM_MATRICULA) MATRICULA,
       TAB.CODINSC,
       TAB.CODCONC,
       ALU.NOM_ALUNO, ALU.NUM_CPF,DSCTPODESCPROMOCAO
  FROM (SELECT INS.CODCONC,
               INS.CODINSC,
               PRO.NOMFUNCIONARIO,
               PRO.CODDESCPROMOCAO,
               DDD.DSCTPODESCPROMOCAO,
               IES.COD_INSTITUICAO_SIAF
          FROM DBVESTIB.PROMOCAO_INSCRICAO PRO
         INNER JOIN DBVESTIB.INSCRICAO INS
            ON (INS.CODCONC = PRO.CODCONC AND INS.CODINSC = PRO.CODINSC)
         INNER JOIN DBVESTIB.DESCONTO_PROMOCAO DES
            ON (DES.CODCONC = INS.CODCONC AND DES.CODDESCPROMOCAO = PRO.CODDESCPROMOCAO)
         INNER JOIN DBVESTIB.TIPO_DESC_PROMOCAO DDD
            ON DDD.CODTPODESCPROMOCAO = DES.CODTPODESCPROMOCAO
         INNER JOIN DBVESTIB.OPCAOCANDIDATO OPC
            ON OPC.CODCONC = INS.CODCONC
               AND OPC.CODINSC = INS.CODINSC
               AND OPC.NROOPC = '1'
         INNER JOIN DBVESTIB.INSTITUICAO_ENSINO IES
            ON IES.CODINSTITUICAO = OPC.CODINSTITUICAO
         WHERE PRO.NOMFUNCIONARIO IS NOT NULL
               AND PRO.CODFUNCIONARIO IS NULL
               AND PRO.NUMMATRICULA IS NULL
               AND TO_CHAR(PRO.DAT_OPERACAO_LOG,
                           'yyyy') = 2016) TAB
  INNER JOIN DBSIAF.ALUNO ALU
    ON UPPER(TAB.NOMFUNCIONARIO) = UPPER(NOM_ALUNO)
       AND ALU.CODCONC IS NOT NULL
       AND ALU.CODCAN IS NOT NULL
  GROUP BY TAB.CODINSC,
          TAB.CODCONC,
          ALU.NOM_ALUNO, ALU.NUM_CPF, DSCTPODESCPROMOCAO;
          
          
BEGIN                 
FOR R_PRO IN C_PRO LOOP
       
       UPDATE DBVESTIB.PROMOCAO_INSCRICAO PPP
       SET PPP.NUMMATRICULA = R_PRO.MATRICULA
       WHERE PPP.CODCONC = R_PRO.CODCONC
       AND PPP.CODINSC = R_PRO.CODINSC;
       COMMIT;               
       
END LOOP;
UPDATE DBVESTIB.PROMOCAO_INSCRICAO PPP
       SET ppp.coddescpromocao = 6038
       WHERE PPP.CODCONC = '3109'
       AND PPP.CODINSC = '757676';
       COMMIT;
END;     
/*
SELECT dbvestib.f_promocao_indicacao(p.codconc,p.codinsc), p.* FROM dbvestib.promocao_inscricao p
inner join dbvestib.inscricao i on p.codconc = i.codconc  and p.codinsc = i.codinsc
where p.codconc = '3109' and cpfcan = '80741711915'


delete from  dbvestib.promocao_inscricao p
where codconc = '3109' and codinsc = '770307'

13259313656

SELECT *
FROM DBVESTIB.DESCONTO_PROMOCAO D
WHERE D.CODCONC = '3109'

SELECT * FROM DBVESTIB.TIPO_DESC_PROMOCAO*/
