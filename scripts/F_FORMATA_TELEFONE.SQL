CREATE OR REPLACE FUNCTION DBVESTIB.F_FORMATA_TELEFONE(P_CODALUNO DBSIAF.ALUNO.COD_ALUNO%TYPE) RETURN DBSIAF.END_ALUNO.TEL_ENDERECO%TYPE IS

	V_TEL      DBSIAF.END_ALUNO.TEL_ENDERECO%TYPE;
	N_TEL      DBSIAF.END_ALUNO.TEL_ENDERECO%TYPE;
	N_TEL2     DBSIAF.END_ALUNO.TEL_ENDERECO%TYPE;
	N_TEL3     DBSIAF.END_ALUNO.TEL_ENDERECO%TYPE;
	V_TELALUNO DBSIAF.ALUNO.TEL_CELULAR%TYPE;
	N_TELALUNO DBSIAF.ALUNO.TEL_CELULAR%TYPE;
	V_DDD      DBSIAF.ALUNO.TEL_CELULAR%TYPE;
	V_CODCAN   DBVESTIB.CANDIDATO.CODCAN%TYPE;

BEGIN
	SELECT CAN.CODCAN
	  INTO V_CODCAN
	  FROM DBVESTIB.CANDIDATO CAN,
		   DBSIAF.ALUNO       AL
	 WHERE AL.CODCAN = CAN.CODCAN
		   AND AL.COD_ALUNO = P_CODALUNO;

	SELECT EAL.TEL_ENDERECO
	  INTO N_TEL
	  FROM DBSIAF.END_ALUNO EAL
	 WHERE EAL.COD_ALUNO = P_CODALUNO
		   AND EAL.COD_TPO_ENDERECO = 1;

	SELECT CAN.TELCAN
	  INTO N_TEL2
	  FROM DBVESTIB.CANDIDATO CAN,
		   DBSIAF.ALUNO       ALU
	 WHERE ALU.COD_ALUNO = P_CODALUNO
		   AND ALU.CODCAN = CAN.CODCAN;

	SELECT ALU.TEL_CELULAR
	  INTO N_TELALUNO
	  FROM DBSIAF.ALUNO ALU
	 WHERE ALU.COD_ALUNO = P_CODALUNO;

	IF N_TEL IS NOT NULL THEN
		V_TEL := REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(TRIM(N_TEL), '(', ''), ')', ''), '-', ''), ' ', ''), '.', ''), '/', '');
	
		UPDATE DBSIAF.END_ALUNO ENA
		   SET ENA.TEL_ENDERECO = V_TEL
		 WHERE ENA.COD_ALUNO = P_CODALUNO
			   AND ENA.COD_TPO_ENDERECO = 1;
	
	END IF;

	IF N_TEL2 IS NOT NULL THEN
		V_TEL := REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(TRIM(N_TEL), '(', ''), ')', ''), '-', ''), ' ', ''), '.', ''), '/', '');
	
		UPDATE DBVESTIB.CANDIDATO CAN
		   SET CAN.TELCAN = V_TEL
		 WHERE CAN.CODCAN = V_CODCAN;
	
		UPDATE DBVESTIB.INSCRICAO INS
		   SET INS.TELCAN = V_TEL
		 WHERE INS.CODINSC = V_CODCAN;
	
		UPDATE DBVESTIB.PREINSCRICAO PRE
		   SET PRE.TELCAN = V_TEL
		 WHERE PRE.CODINSC = V_CODCAN;
	
	END IF;

	IF N_TELALUNO IS NOT NULL THEN
		V_TELALUNO := REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(TRIM(N_TELALUNO), '(', ''), ')', ''), '-', ''), ' ', ''), '.', ''), '/', '');
		-- Desabilita a trigger 
		DBSIAF.PC_MUTANTE_TABLE.SP_INSERE('TEL', 'FORMATA', 'S');
	
		UPDATE DBSIAF.ALUNO ALU
		   SET ALU.TEL_CELULAR = V_TELALUNO
		 WHERE ALU.COD_ALUNO = P_CODALUNO;
	
		DBSIAF.PC_MUTANTE_TABLE.SP_LIMPA_TEMPORARIA('TEL', 'FORMATA');
	END IF;

	--  V_DDD := SUBSTR(V_TELALUNO, 0, 2);

	--  V_TELALUNO := SUBSTR(V_TELALUNO, 3, 10);

	COMMIT;

	RETURN V_TEL;

EXCEPTION
	WHEN OTHERS THEN
		RETURN 0;
	
END F_FORMATA_TELEFONE;
/
